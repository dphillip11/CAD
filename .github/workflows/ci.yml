name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint (pre-commit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y clang-format shellcheck

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks (check)
        run: pre-commit run --all-files --show-diff-on-failure

  build-and-test:
    name: Build and test (native)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Cache GoogleTest build
        uses: actions/cache@v4
        with:
          path: |
            build/_deps/googletest-build
          key: ${{ runner.os }}-cad-gtest-${{ hashFiles('test/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cad-gtest-

      - name: Check CMake
        run: cmake --version || true

      - name: Install CMake on Ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: |
          if ! command -v cmake >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y cmake
          fi

      - name: Install CMake on macOS
        if: matrix.os == 'macos-latest'
        run: |
          if ! command -v cmake >/dev/null 2>&1; then
            brew install cmake
          fi

      - name: Verify CMake installation
        run: |
          if ! command -v cmake >/dev/null 2>&1; then
            echo "Error: cmake is not available after attempted installation."
            echo "Check previous logs for installation errors and ensure the runner can install packages."
            exit 1
          fi
          cmake --version

      - name: Install OpenGL/GLFW/GLEW dependencies on Ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libglfw3-dev libglew-dev xorg-dev

      - name: Install OpenGL/GLFW/GLEW dependencies on macOS
        if: matrix.os == 'macos-latest'
        run: |
          brew install glfw glew

      - name: Configure (enable tests)
        run: cmake -S . -B build -D CMAKE_BUILD_TYPE=Release -D BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --config Release -- -j 2

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

  web-build:
    name: Build web (Emscripten)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Note: Emscripten build has tests disabled, so no GoogleTest caching needed

      - name: Cache Emscripten SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.emsdk
            ~/.emscripten
          key: emsdk-${{ runner.os }}-v1
          restore-keys: |
            emsdk-${{ runner.os }}-

      - name: Install or update Emscripten SDK and build web artifact
        run: |
          set -euo pipefail
          # Clone or update emsdk in $HOME/.emsdk
          if [ -d "$HOME/.emsdk" ]; then
            cd "$HOME/.emsdk" && git pull || true
          else
            git clone https://github.com/emscripten-core/emsdk.git "$HOME/.emsdk"
          fi
          cd "$HOME/.emsdk"
          ./emsdk install latest
          ./emsdk activate latest
          # Source the environment for this step and run the build in the same shell
          # so that emcc is available when running the build script.
          source ./emsdk_env.sh
          emcc --version
          # Ensure we are in the repository workspace when running the build script
          cd "$GITHUB_WORKSPACE"
          ls -la || true
          if [ ! -f scripts/build-web.sh ]; then
            echo "Error: scripts/build-web.sh not found in repository workspace (pwd=$(pwd))"
            exit 1
          fi
          chmod +x scripts/build-web.sh
          ./scripts/build-web.sh

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: web

  deploy-pages:
    name: Deploy web/ to GitHub Pages
    runs-on: ubuntu-latest
    needs: web-build
    # Only deploy for pushes to main (not for pull_request events)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web
          path: web

      - name: Verify web artifact
        run: |
          echo "Contents of web/"
          ls -la web || true
          if [ ! -f web/hello.html ]; then
            echo "Error: web/hello.html not found"
            exit 1
          fi
          if [ ! -f web/index.html ]; then
            echo "Warning: web/index.html not found — creating a simple index.html to redirect to hello.html"
            echo '<!doctype html><meta http-equiv="refresh" content="0; url=hello.html">' > web/index.html
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          # Prefer a user-provided PAT with repo write access if present (secrets.GH_PAGES_PAT),
          # otherwise fall back to the default GITHUB_TOKEN. If you see a 403 on push,
          # add a PAT with 'repo' scope as a repository secret named GH_PAGES_PAT or
          # enable 'Read and write permissions' for Actions in repository settings.
          github_token: ${{ secrets.GH_PAGES_PAT || secrets.GITHUB_TOKEN }}
          publish_dir: ./web
          publish_branch: gh-pages
          # Keep history small and avoid empty commits
          allow_empty_commit: false

  pages-smoke-test:
    name: Smoke test GitHub Pages
    runs-on: ubuntu-latest
    needs: deploy-pages
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Wait for site to become available and verify build-info.txt
        run: |
          set -euo pipefail
          OWNER="$(echo "$GITHUB_REPOSITORY" | cut -d/ -f1)"
          REPO="$(echo "$GITHUB_REPOSITORY" | cut -d/ -f2)"
          SITE_URL="https://${OWNER}.github.io/${REPO}"
          BUILD_INFO_URL="${SITE_URL}/build-info.txt"
          
          echo "Checking ${BUILD_INFO_URL}"
          SUCCESS=1
          for i in $(seq 1 12); do
            echo "Attempt ${i}/12..."
            if curl -sSfL "${BUILD_INFO_URL}" -o /tmp/build-info.txt; then
              echo "Successfully fetched build-info.txt:"
              cat /tmp/build-info.txt
              
              # Verify it contains expected fields
              if grep -q "build_time:" /tmp/build-info.txt && grep -q "git_commit:" /tmp/build-info.txt; then
                COMMIT_HASH=$(grep "git_commit:" /tmp/build-info.txt | cut -d' ' -f2)
                echo "✓ Deployment verified - commit: ${COMMIT_HASH}"
                SUCCESS=0
                break
              else
                echo "⚠ build-info.txt found but missing expected fields"
              fi
            else
              echo "Unable to fetch build-info.txt yet (site may still be deploying)"
            fi
            sleep 10
          done
          
          if [ "$SUCCESS" -ne 0 ]; then
            echo "✗ Smoke test failed: ${BUILD_INFO_URL} not available after 2 minutes"
            exit 1
          fi

